<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Reloverse ‚Äî Graphical Toaster RPG</title>
<style>
  :root{
    --bg:#0b1020; --panel:#0f1a2b; --accent:#ffb86b; --muted:#9aa3c7;
    --good:#8be385; --bad:#ff7b7b;
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
  }
  *{box-sizing:border-box}
  body{margin:0; min-height:100vh; background:linear-gradient(180deg,#071228,#061224); color:#eaf2ff; display:flex; align-items:center; justify-content:center; padding:20px;}
  .game {
    width:1100px; max-width:100%; display:grid; grid-template-columns:700px 360px; gap:18px;
  }

  /* Room / stage */
  .stage {
    background: linear-gradient(180deg,#e9f1ff 0%, #dbe9ff 55%, #e9f1ff 100%);
    border-radius:14px; height:680px; position:relative; overflow:hidden; box-shadow: 0 20px 60px rgba(2,6,23,0.75);
    border:8px solid rgba(0,0,0,0.25);
  }

  /* HUD overlay */
  .hud {
    position:absolute; left:16px; top:16px; background:rgba(6,10,20,0.6); padding:10px 14px; border-radius:10px; backdrop-filter: blur(4px);
    display:flex; gap:12px; align-items:center;
  }
  .hud .stat{font-size:14px; color:var(--muted)}
  .hud .stat strong{color:var(--accent)}

  /* Sprites */
  .sprite { position:absolute; cursor:pointer; transition:transform .18s ease, box-shadow .18s ease; user-select:none; }
  .sprite:hover { transform:translateY(-6px) scale(1.02); box-shadow: 0 18px 40px rgba(2,6,23,0.5); }

  #deskImg { left:36px; bottom:32px; width:240px; }
  #bedImg  { right:24px; bottom:12px; width:260px; }
  #toasterImg { left:320px; bottom:60px; width:150px; transition: transform .12s ease; }
  #doorArea { left:520px; top:36px; width:140px; height:220px; border-radius:10px; background:linear-gradient(180deg,#e0cfa7,#d5b07a); border:6px solid rgba(0,0,0,0.18); display:flex; align-items:center; justify-content:center; font-weight:700; color:#2a1b00; }
  #doorArea:hover{ transform:translateY(-4px) }

  /* Right panel */
  .panel {
    background: linear-gradient(180deg,#071228,#041024);
    padding:12px;border-radius:12px; height:680px; display:flex; flex-direction:column; gap:12px; box-shadow: 0 20px 60px rgba(2,6,23,0.6);
  }
  .panel h3{margin:0 0 8px 0; color:var(--accent)}
  .info { background:rgba(255,255,255,0.03); padding:10px; border-radius:10px; color:var(--muted); font-size:14px }

  /* Battle area inside stage */
  .battleArea { position:absolute; left:40px; right:40px; top:120px; height:380px; pointer-events:none; }
  .combatant { position:absolute; bottom:20px; width:260px; height:260px; display:flex; flex-direction:column; align-items:center; justify-content:flex-end; gap:8px; pointer-events:auto; }
  .playerWrap { left:40px; }
  .enemyWrap { right:40px; transform:scaleX(-1); } /* flip enemy for facing */
  .combatImg { width:180px; height:180px; object-fit:contain; border-radius:10px; box-shadow: 0 10px 30px rgba(0,0,0,0.45); }
  .hpBar { width:240px; height:12px; background:rgba(255,255,255,0.06); border-radius:10px; overflow:hidden; }
  .hpBar > i { display:block; height:100%; background:linear-gradient(90deg,#8be385,#2bb673); width:100%; transition:width .28s ease; }

  .enemyMeta { color:var(--muted); font-size:13px }

  /* Actions */
  .actions { display:flex; gap:8px; flex-wrap:wrap; margin-top:4px; }
  .btn { background:linear-gradient(180deg,#14263a,#081525); color:#dfe9ff; padding:8px 12px; border-radius:8px; border:1px solid rgba(255,255,255,0.03); cursor:pointer; }
  .btn.danger { background:linear-gradient(180deg,#3b0b0b,#2b0606); color:#ffd6d6 }

  /* Log */
  .log { background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-radius:8px; padding:8px; height:120px; overflow:auto; font-size:13px; color:var(--muted) }

  /* Modal overlay */
  .modal { position:fixed; left:0; top:0; right:0; bottom:0; display:flex; align-items:center; justify-content:center; background:rgba(3,6,15,0.7); z-index:120; }
  .card { background:linear-gradient(180deg,#0d1723,#081025); padding:16px; border-radius:12px; width:760px; max-width:94%; color:#eaf2ff; box-shadow:0 20px 60px rgba(2,6,23,0.8) }

  /* Minigame UI */
  .minigameSeq { display:flex; gap:10px; justify-content:center; margin-top:12px; }
  .minArrow { width:72px; height:72px; border-radius:10px; display:flex; align-items:center; justify-content:center; font-size:36px; background:rgba(255,255,255,0.03); border:2px solid rgba(255,255,255,0.03); color:#eaf2ff; }
  .minArrow.success { box-shadow:0 12px 30px rgba(139,227,133,0.12); border-color:rgba(139,227,133,0.18) }
  .minArrow.fail { box-shadow:0 12px 30px rgba(255,123,123,0.12); border-color:rgba(255,123,123,0.18) }
  .timingBar { height:8px; width:100%; background:rgba(255,255,255,0.04); border-radius:8px; overflow:hidden; margin-top:10px }
  .timingFill { height:100%; background:linear-gradient(90deg,#ffb86b,#ffd2a3); width:100%; transition:width linear; }

  /* small tweaks */
  footer small{color:var(--muted)}
  @media (max-width:1120px){ .game{grid-template-columns:1fr; } .stage{height:640px} .panel{height:auto} }
</style>
</head>
<body>
<div class="game">
  <div class="stage" id="stage">
    <div class="hud">
      <div class="stat">Day: <strong id="day">1</strong></div>
      <div class="stat">Level: <strong id="level">1</strong></div>
      <div class="stat">XP: <strong id="xp">0</strong>/<span id="xpToNext">20</span></div>
      <div class="stat">Grade: <strong id="grade">70</strong>%</div>
      <div style="width:10px"></div>
      <div class="stat">HP: <strong id="hpText">30</strong>/<span id="maxHpText">30</span></div>
    </div>

    <img src="desk.jpg" id="deskImg" class="sprite" alt="Desk" />
    <img src="bed.jpg" id="bedImg" class="sprite" alt="Bed" />
    <img src="toaster.jpg" id="toasterImg" class="sprite" alt="Toaster" />
    <div id="doorArea" class="sprite" title="Leave to school">DOOR</div>

    <!-- battle stage sits above background -->
    <div class="battleArea" id="battleArea" aria-hidden="true">
      <div class="combatant playerWrap" id="playerWrap" style="display:none; pointer-events:auto">
        <img src="toaster.jpg" class="combatImg" id="playerCombatImg" alt="Player" />
        <div class="hpBar"><i id="playerHpFill" style="width:100%"></i></div>
        <div class="enemyMeta" id="playerLabel">Toaster ‚Äî Lv 1</div>
      </div>

      <div class="combatant enemyWrap" id="enemyWrap" style="display:none; pointer-events:auto">
        <!-- enemy will be generated as emoji graphic -->
        <div style="width:180px;height:180px;display:flex;align-items:center;justify-content:center;font-size:88px; background:linear-gradient(180deg,#ffdede,#ffb7b7);border-radius:12px; box-shadow: 0 10px 30px rgba(0,0,0,0.45);" id="enemyGraphic">üè´</div>
        <div class="hpBar" style="transform:scaleX(-1)"><i id="enemyHpFill" style="width:100%"></i></div>
        <div class="enemyMeta" id="enemyLabel">No enemy</div>
      </div>
    </div>

    <div style="position:absolute; left:20px; right:20px; bottom:18px; display:flex; gap:12px; align-items:flex-end; justify-content:space-between;">
      <div style="width:48%">
        <div class="log" id="log">Welcome to Reloverse ‚Äî click desk/bed/door or use HUD actions.</div>
      </div>

      <div style="width:48%; display:flex; flex-direction:column; gap:8px;">
        <div style="display:flex; gap:8px; align-items:center;">
          <div style="flex:1"><strong style="color:var(--accent)">Moves</strong></div>
          <div><button class="btn" id="saveBtn">Save</button></div>
          <div><button class="btn danger" id="resetBtn">Reset</button></div>
        </div>
        <div id="movesArea" style="display:flex; gap:8px; flex-wrap:wrap;"></div>
      </div>
    </div>
  </div>

  <div class="panel">
    <h3>Battle & Options</h3>
    <div class="info">
      <div id="enemyInfoShort">No active battle</div>
      <div style="height:8px"></div>
      <div style="display:flex; gap:6px; align-items:center;">
        <button class="btn" id="autoBtn">Auto-fight (off)</button>
        <button class="btn" id="practiceBtn">Practice Move</button>
      </div>
    </div>

    <h3>Actions</h3>
    <div class="info small">
      <strong>Desk:</strong> harder minigame ‚Äî long sequences, shrinking timing windows. Use W/A/S/D or arrow keys.<br>
      <strong>Bed:</strong> rest and watch toaster-themed short cutscenes.<br>
      <strong>Door:</strong> fight the school boss ‚Äî gets harder each day.
    </div>

    <h3>Inventory</h3>
    <div class="info" id="invBox">Empty</div>

    <h3>Quick Log</h3>
    <div class="info small" id="quickStats">Level 1 ‚Ä¢ XP 0 ‚Ä¢ Grade 70%</div>

    <div style="margin-top:auto; text-align:center; font-size:12px; color:var(--muted)"><small>Sprites expected at: <code>toaster.jpg</code>, <code>desk.jpg</code>, <code>bed.jpg</code></small></div>
  </div>
</div>

<!-- Modal root -->
<div id="modalRoot" style="display:none"></div>

<script>
/* -------------------------------
   Reloverse Graphical ‚Äî single file
   ------------------------------- */

/* DATA MODEL */
const defaultData = {
  day: 1, level:1, xp:0, xpToNext:20, grade:70,
  maxHp:30, hp:30, inventory:['Toaster crumb','Old game cartridge'],
  moves:[
    {id:'toastBlast',name:'Toast Blast',desc:'Hot bread shot',power:6,unlocked:true},
    {id:'crumbShield',name:'Crumb Shield',desc:'Reduces incoming damage (proc)',power:0,unlocked:false},
    {id:'popUpSurprise',name:'Pop-Up Surprise',desc:'High-crit toaster pop-up',power:14,unlocked:false},
    {id:'butterSlip',name:'Butter Slip',desc:'Chance to evade next attack',power:10,unlocked:false},
  ],
  autoFight:false
};

let state = loadState();
let battle = null;

const ui = {
  day: document.getElementById('day'),
  level: document.getElementById('level'),
  xp: document.getElementById('xp'),
  xpToNext: document.getElementById('xpToNext'),
  grade: document.getElementById('grade'),
  hpText: document.getElementById('hpText'),
  maxHpText: document.getElementById('maxHpText'),
  log: document.getElementById('log'),
  invBox: document.getElementById('invBox'),
  movesArea: document.getElementById('movesArea'),
  enemyInfoShort: document.getElementById('enemyInfoShort'),
  quickStats: document.getElementById('quickStats'),
  playerWrap: document.getElementById('playerWrap'),
  enemyWrap: document.getElementById('enemyWrap'),
  playerHpFill: document.getElementById('playerHpFill'),
  enemyHpFill: document.getElementById('enemyHpFill'),
  playerLabel: document.getElementById('playerLabel'),
  enemyLabel: document.getElementById('enemyLabel'),
  enemyGraphic: document.getElementById('enemyGraphic'),
  saveBtn: document.getElementById('saveBtn'),
  resetBtn: document.getElementById('resetBtn'),
  deskImg: document.getElementById('deskImg'),
  bedImg: document.getElementById('bedImg'),
  toasterImg: document.getElementById('toasterImg'),
  doorArea: document.getElementById('doorArea'),
  modalRoot: document.getElementById('modalRoot'),
  autoBtn: document.getElementById('autoBtn'),
  practiceBtn: document.getElementById('practiceBtn')
};

/* UTIL */
function loadState(){
  try{ const raw = localStorage.getItem('reloverse_graphic_v1'); if(raw) return JSON.parse(raw); }catch(e){}
  return JSON.parse(JSON.stringify(defaultData));
}
function saveState(){ localStorage.setItem('reloverse_graphic_v1', JSON.stringify(state)); }
function log(msg){
  const time = new Date().toLocaleTimeString();
  ui.log.innerHTML = `<div style="margin-bottom:6px">[${time}] ${escapeHtml(msg)}</div>` + ui.log.innerHTML;
  // update short info
  ui.quickStats.textContent = `Level ${state.level} ‚Ä¢ XP ${state.xp}/${state.xpToNext} ‚Ä¢ Grade ${Math.round(state.grade)}%`;
}
function escapeHtml(s){ return String(s).replace(/[&<>]/g, c=> ({'&':'&amp;','<':'&lt;','>':'&gt;'}[c])); }

/* UI update */
function updateUI(){
  ui.day.textContent = state.day;
  ui.level.textContent = state.level;
  ui.xp.textContent = state.xp;
  ui.xpToNext.textContent = state.xpToNext;
  ui.grade.textContent = Math.max(0, Math.min(100, Math.round(state.grade)));
  ui.hpText.textContent = state.hp;
  ui.maxHpText.textContent = state.maxHp;
  ui.invBox.textContent = state.inventory.join(', ');
  ui.playerLabel.textContent = `Toaster ‚Äî Lv ${state.level}`;
  const playerPct = Math.max(0, Math.min(100, Math.round((state.hp/state.maxHp)*100)));
  ui.playerHpFill.style.width = playerPct + '%';

  // moves
  ui.movesArea.innerHTML = '';
  for(const m of state.moves.filter(x=>x.unlocked)){
    const b = document.createElement('button');
    b.className = 'btn';
    b.textContent = `${m.name} (${m.power})`;
    b.title = m.desc;
    b.onclick = ()=> {
      if(battle) playerAttack(m);
      else useMovePractice(m);
    };
    ui.movesArea.appendChild(b);
  }
  ui.autoBtn.textContent = state.autoFight ? 'Auto-fight (ON)' : 'Auto-fight (OFF)';
  saveState();
}

/* XP & Level */
function addXp(amount){
  state.xp += amount;
  log(`Gained ${amount} XP.`);
  while(state.xp >= state.xpToNext){
    state.xp -= state.xpToNext;
    levelUp();
  }
  updateUI();
}
function levelUp(){
  state.level += 1;
  state.maxHp += 6;
  state.hp = state.maxHp;
  state.xpToNext = Math.round(state.xpToNext * 1.35);
  const unlocks = {
    2: 'crumbShield', 4: 'popUpSurprise', 6: 'butterSlip'
  };
  const id = unlocks[state.level];
  if(id){
    const mv = state.moves.find(m=>m.id===id);
    if(mv) mv.unlocked = true;
    showModal(`<div style="font-size:22px">‚ú® New Move: ${mv.name}</div><div style="margin-top:8px">${escapeHtml(mv.desc)}</div>`, true);
    log(`Unlocked move: ${mv.name}`);
  }
  log(`Leveled up to ${state.level}!`);
}

/* Move practice (non-battle) */
function useMovePractice(m){
  const gain = Math.max(1, Math.round(m.power/2));
  addXp(gain);
  log(`You practiced ${m.name} and earned ${gain} XP.`);
  if(Math.random() < 0.12){
    state.inventory.push('Fresh Crumb');
    log('Found Fresh Crumb!');
    updateUI();
  }
}

/* ============================
   BATTLE system (sprite-based)
   ============================ */

function createBossForDay(day){
  const hp = 40 + (day-1)*16;
  const atk = 7 + Math.floor((day-1)*2.5);
  const names = ['Principal Parch','Homework Hydra','Detention Drum','Quizmaster Quill'];
  const icons = ['üë®‚Äçüè´','ü¶ï','ü•Å','‚úíÔ∏è'];
  const idx = (day-1) % names.length;
  return {
    name: names[idx],
    icon: icons[idx],
    hp: hp, maxHp: hp, atk: atk, day:day, isBoss:true
  };
}

function startBattle(enemy){
  if(battle) return;
  battle = { enemy, turn:'player', evadeNext:false };
  ui.enemyInfoShort.textContent = `${enemy.name} appears (Day ${state.day})`;
  // show combatants
  ui.playerWrap.style.display = 'block';
  ui.enemyWrap.style.display = 'block';
  ui.enemyGraphic.textContent = enemy.icon;
  ui.enemyLabel.textContent = `${enemy.name} ‚Ä¢ Day ${state.day}`;
  ui.enemyHpFill.style.width = '100%';
  log(`${enemy.name} appears!`);
  if(state.autoFight) autoBattleLoop();
  updateUI();
}

function endBattle(won, reason){
  if(!battle) return;
  if(won){
    log(`Defeated ${battle.enemy.name}!`);
    const xpGain = 12 + Math.round(battle.enemy.maxHp/8) + (state.day-1)*2;
    addXp(xpGain);
    const gradeGain = 3 + Math.round(state.day/4);
    state.grade = Math.min(100, state.grade + gradeGain);
    if(battle.enemy.isBoss){
      state.day += 1;
      showModal(`<div style="font-size:20px">Victory! Day advanced to ${state.day}.</div><div class="small">A toaster-themed short plays in your head.</div>`, true);
    }
  } else {
    log(`Lost battle: ${reason || 'defeat'}`);
    state.hp = Math.max(1, Math.round(state.hp * 0.52));
    state.grade = Math.max(0, state.grade - 6);
  }
  // hide combatants
  ui.playerWrap.style.display = 'none';
  ui.enemyWrap.style.display = 'none';
  battle = null;
  updateUI();
}

function enemyAttack(){
  if(!battle) return;
  const e = battle.enemy;
  let dmg = e.atk + Math.floor(Math.random()*5) - Math.floor(state.level/3);
  if(dmg < 1) dmg = 1;
  // crumb shield proc
  const shield = state.moves.find(m=>m.id==='crumbShield' && m.unlocked);
  if(shield && Math.random()<0.18){
    dmg = Math.max(0, dmg - 6);
    log('Crumb Shield reduced incoming damage!');
  }
  if(battle.evadeNext){
    log('You evaded the incoming attack thanks to Butter Slip!');
    battle.evadeNext = false;
  } else {
    state.hp -= dmg;
    log(`${e.name} hits for ${dmg} damage.`);
  }
  if(state.hp <= 0){
    state.hp = 0;
    updateUI();
    log('Toaster toasted! You lost.');
    endBattle(false,'defeat');
  } else {
    updateUI();
  }
}

function playerAttack(move){
  if(!battle) return;
  // small animation: pop toaster
  ui.toasterImg.style.transform = 'translateY(-10px) scale(1.03)';
  setTimeout(()=> ui.toasterImg.style.transform = '', 160);

  let base = move.power + Math.floor(state.level * 1.3) + Math.floor(Math.random()*5);
  if(move.id === 'popUpSurprise' && Math.random() < 0.35){
    base *= 2;
    log('Pop-Up Surprise critical!');
  }
  if(move.id === 'butterSlip' && Math.random() < 0.28){
    log('Butter Slip activated ‚Äî you will evade the next attack!');
    battle.evadeNext = true;
  }
  battle.enemy.hp -= base;
  log(`You used ${move.name} ‚Äî dealt ${base} damage.`);
  // update enemy hp fill
  const pct = Math.max(0, Math.min(100, (battle.enemy.hp/battle.enemy.maxHp)*100));
  ui.enemyHpFill.style.width = pct + '%';
  if(battle.enemy.hp <= 0){
    endBattle(true, battle.enemy.isBoss ? 'boss' : 'monster');
    return;
  }
  // enemy attacks shortly after
  setTimeout(enemyAttack, 700);
}

/* Auto loop */
function autoBattleLoop(){
  if(!state.autoFight || !battle) return;
  if(battle.turn === 'player'){
    const usable = state.moves.filter(m=>m.unlocked);
    const pick = usable[Math.floor(Math.random()*usable.length)];
    playerAttack(pick);
  }
  setTimeout(()=> {
    if(state.autoFight && battle) autoBattleLoop();
  }, 900);
}

/* ======================
   DESK MINIGAME ‚Äî HARD
   ======================
   - Generates a long sequence
   - Each step has a shrinking time window; player must press correct key within time
   - Visual timing bar indicates remaining time
   - Fail if time runs out or wrong key; sequence requires multiple perfect segments to 'combo' success
*/
function playDeskMinigame(){
  // difficulty scales: base length + level/day
  const baseLen = 6;
  const len = baseLen + Math.min(8, Math.floor(state.level/1.2)) + Math.min(6, Math.floor(state.day/2));
  const arrows = ['‚ñ≤','‚ñ∂','‚ñº','‚óÄ'];
  const seq = Array.from({length:len}, ()=> arrows[Math.floor(Math.random()*arrows.length)]);

  // show complex modal
  ui.modalRoot.innerHTML = '';
  const mm = document.createElement('div');
  mm.className = 'modal';
  const card = document.createElement('div'); card.className='card';
  card.innerHTML = `<div style="font-size:20px">Study Minigame ‚Äî Concentration Test</div>
    <div class="small" style="margin-top:6px">Press W/A/S/D or Arrow keys in time. Windows shrink as you progress ‚Äî be quick and accurate!</div>
    <div id="seqWrap" style="margin-top:12px"></div>
    <div class="timingBar"><div class="timingFill" id="timingFill"></div></div>
    <div style="display:flex; justify-content:center; gap:10px; margin-top:12px;"><button class="btn" id="quitMini">Quit</button></div>`;
  mm.appendChild(card);
  ui.modalRoot.appendChild(mm);
  ui.modalRoot.style.display = 'block';

  const seqWrap = document.getElementById('seqWrap');
  const timingFill = document.getElementById('timingFill');
  const quitBtn = document.getElementById('quitMini');

  // build arrow elements
  seqWrap.innerHTML = '';
  const arrowEls = seq.map(s=>{
    const d = document.createElement('div'); d.className='minArrow'; d.textContent = s; seqWrap.appendChild(d); return d;
  });

  // game vars
  let idx = 0;
  let successes = 0;
  let active = true;
  // starting time window: harder than before
  let timeWindow = Math.max(500, 1100 - state.level*40 - state.day*20); // ms
  // we'll shrink by factor each successful hit
  function step(){
    if(!active) return;
    if(idx >= seq.length) return finish();
    // highlight current
    arrowEls.forEach((el,i)=>{ el.classList.remove('success','fail'); el.style.opacity = i < idx ? '0.45' : '1'; });
    const cur = arrowEls[idx];
    cur.style.boxShadow = '0 10px 30px rgba(255,200,80,0.12); border-color:rgba(255,200,80,0.18)';
    // animate timing bar from full to zero in timeWindow
    timingFill.style.transition = `width ${timeWindow}ms linear`;
    timingFill.style.width = '100%';
    // small micro-tick to ensure CSS transition applies
    setTimeout(()=> timingFill.style.width = '0%', 8);

    // handler
    const keyMap = {'ArrowUp':'‚ñ≤','ArrowDown':'‚ñº','ArrowLeft':'‚óÄ','ArrowRight':'‚ñ∂','w':'‚ñ≤','s':'‚ñº','a':'‚óÄ','d':'‚ñ∂'};
    let handled = false;
    function onKey(e){
      if(!active) return;
      const got = keyMap[e.key];
      if(!got) return;
      handled = true;
      window.removeEventListener('keydown', onKey);
      timingFill.style.transition = ''; timingFill.style.width = '0%';
      if(got === seq[idx]){
        cur.classList.add('success');
        successes++;
        idx++;
        // shrink time window (harder)
        timeWindow = Math.max(280, Math.round(timeWindow * 0.92));
        // small reward chance
        if(Math.random() < 0.06) { state.inventory.push('Study Sticker'); log('Found a Study Sticker!'); }
        setTimeout(step, 260);
      } else {
        cur.classList.add('fail');
        active = false;
        window.removeEventListener('keydown', onKey);
        finish(false);
      }
    }

    window.addEventListener('keydown', onKey);
    // if time runs out
    const to = setTimeout(()=>{
      if(handled) return;
      active = false;
      window.removeEventListener('keydown', onKey);
      cur.classList.add('fail');
      finish(false);
    }, timeWindow + 20);
    // quit button
    quitBtn.onclick = ()=> { active = false; window.removeEventListener('keydown', onKey); clearTimeout(to); ui.modalRoot.style.display='none'; ui.modalRoot.innerHTML=''; log('Quit the minigame.'); };
  }

  function finish(successful=true){
    ui.modalRoot.style.display='none'; ui.modalRoot.innerHTML='';
    if(successful){
      const gradeGain = Math.min(20, Math.round(successes * 3 + state.level/2));
      const xpGain = Math.max(6, Math.round(successes * 4 + state.level));
      state.grade = Math.min(100, state.grade + gradeGain);
      addXp(xpGain);
      log(`Minigame success: ${successes}/${seq.length}. Grade +${gradeGain}, XP +${xpGain}.`);
    } else {
      const penalty = Math.max(1, Math.round(seq.length/3));
      state.grade = Math.max(0, state.grade - penalty);
      log(`Minigame failed at step ${idx+1}. Grade -${penalty}. Keep practicing.`);
    }
    updateUI();
    saveState();
  }

  // start
  step();
}

/* =========================
   Bed / Movies / Rest
   ========================= */
function useBed(){
  const heal = Math.min(state.maxHp - state.hp, Math.max(8, Math.round(state.maxHp*0.4)));
  state.hp += heal;
  state.grade = Math.min(100, state.grade + 1);
  log(`You slept and restored ${heal} HP. Grade +1.`);
  const clips = [
    ['A buttery comet sails by...','You dream of perfect toast.','Inspired!'],
    ['Old arcade beeps in the distance.','Toaster levels up in your dreams.','You remember a powerful combo.'],
    ['A tiny film of crumbs parades across the screen.','You learn a subtle trick.','New strategy unlocked in your head.']
  ];
  const clip = clips[Math.floor(Math.random()*clips.length)];
  showCutscene(clip);
  updateUI();
  saveState();
}

/* =========================
   Door interaction
   ========================= */
function goToDoor(){
  if(battle) { log('You are already in a fight.'); return; }
  const boss = createBossForDay(state.day);
  startBattle(boss);
}

/* =========================
   Modals / Cutscenes
   ========================= */
function showModal(html, closable=true){
  ui.modalRoot.innerHTML = '';
  const el = document.createElement('div'); el.className='modal';
  const card = document.createElement('div'); card.className='card';
  card.innerHTML = html + `<div style="margin-top:12px; text-align:center;">${closable?'<button class="btn" id="closeModal">Close</button>':''}</div>`;
  el.appendChild(card); ui.modalRoot.appendChild(el); ui.modalRoot.style.display='block';
  if(closable) document.getElementById('closeModal').onclick = ()=> { ui.modalRoot.style.display='none'; ui.modalRoot.innerHTML=''; };
}
function showCutscene(lines){
  ui.modalRoot.innerHTML = '';
  const el = document.createElement('div'); el.className='modal';
  const card = document.createElement('div'); card.className='card';
  const stage = document.createElement('div'); stage.style.minHeight='160px'; stage.style.display='flex'; stage.style.flexDirection='column'; stage.style.alignItems='center'; stage.style.justifyContent='center';
  card.appendChild(stage);
  card.innerHTML = `<div style="font-size:18px; font-weight:700; margin-bottom:8px">Toaster Short</div>` + card.innerHTML;
  el.appendChild(card); ui.modalRoot.appendChild(el); ui.modalRoot.style.display='block';
  let i=0;
  function next(){
    if(i>=lines.length){ ui.modalRoot.style.display='none'; ui.modalRoot.innerHTML=''; return; }
    stage.innerHTML = `<div style="font-size:48px">üçû</div><div style="font-size:18px">${escapeHtml(lines[i])}</div>`;
    i++;
    setTimeout(next, 1500);
  }
  next();
}

/* =========================
   Events & Boot
   ========================= */
ui.saveBtn.onclick = ()=> { saveState(); log('Saved.'); };
ui.resetBtn.onclick = ()=> { if(confirm('Reset all progress?')){ localStorage.removeItem('reloverse_graphic_v1'); state = JSON.parse(JSON.stringify(defaultData)); updateUI(); log('Progress reset.'); } };
ui.deskImg.onclick = ()=> playDeskMinigame();
ui.bedImg.onclick = ()=> useBed();
ui.toasterImg.onclick = ()=> log('Toaster wiggles happily. üçû');
ui.doorArea.onclick = ()=> goToDoor();
ui.autoBtn.onclick = ()=> { state.autoFight = !state.autoFight; updateUI(); if(state.autoFight && battle) autoBattleLoop(); };
ui.practiceBtn.onclick = ()=> { // quick practice random unlocked move
  const candidates = state.moves.filter(m=>m.unlocked);
  const pick = candidates[Math.floor(Math.random()*candidates.length)];
  useMovePractice(pick);
};

function playerAttackFromUI(id){
  const m = state.moves.find(x=>x.id===id && x.unlocked);
  if(m && battle) playerAttack(m);
}

/* quick keyboard shortcuts during battle */
window.addEventListener('keydown', (e)=>{
  if(!battle) return;
  const keyMap = {'1':0,'2':1,'3':2,'4':3};
  if(keyMap[e.key] !== undefined){
    const unlocked = state.moves.filter(m=>m.unlocked);
    const idx = keyMap[e.key];
    if(unlocked[idx]) playerAttack(unlocked[idx]);
  }
});

/* Bootstrap */
(function init(){
  // ensure move list has defaults (compat)
  const knownIds = ['toastBlast','crumbShield','popUpSurprise','butterSlip'];
  for(const id of knownIds){
    if(!state.moves.find(m=>m.id===id)){
      // add missing
      const template = defaultData.moves.find(m=>m.id===id);
      if(template) state.moves.push({...template});
    }
  }
  // set initial xp/hp sanity
  if(!state.maxHp) state.maxHp = 30;
  if(!state.hp) state.hp = state.maxHp;
  updateUI();
  log('Reloverse loaded ‚Äî graphical mode.');
  // show tutorial once
  if(!localStorage.getItem('reloverse_graphic_seen_tutorial')){
    localStorage.setItem('reloverse_graphic_seen_tutorial','1');
    showModal(`<div style="font-size:20px">Welcome to Reloverse (Graphical)</div>
      <div style="margin-top:8px" class="small">Click the desk to play the harder minigame (use W/A/S/D or arrow keys). Click bed to rest and see toaster shorts. Click DOOR to face the school boss. Level up to unlock moves. Save is automatic.</div>`);
  }
})();

</script>
</body>
</html>
